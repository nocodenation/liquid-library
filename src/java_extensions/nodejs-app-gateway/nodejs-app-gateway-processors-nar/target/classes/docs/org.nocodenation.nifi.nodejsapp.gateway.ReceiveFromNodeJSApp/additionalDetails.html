<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>ReceiveFromNodeJSApp</title>
    <link rel="stylesheet" href="../../../../../css/component-usage.css" type="text/css"/>
</head>
<body>

<h1>ReceiveFromNodeJSApp</h1>

<h2>Description</h2>
<p>
    Receives HTTP requests from Node.js applications via the NodeJSAppAPIGateway controller service.
    This processor uses a queue-based approach with direct access to the gateway's internal queue,
    providing zero-latency integration for high-performance scenarios.
</p>

<h2>How It Works</h2>
<p>
    The processor registers an endpoint pattern with the NodeJSAppAPIGateway service and polls
    the internal request queue. When requests arrive at the gateway matching the endpoint pattern,
    they are queued and processed by this processor, creating FlowFiles with the request data.
</p>

<h3>Architecture</h3>
<pre>
Node.js App → HTTP POST → Gateway (port 5050) → Queue → Java Processor → FlowFile
</pre>

<h2>Configuration</h2>

<h3>Required Properties</h3>
<ul>
    <li><strong>Gateway Service</strong> - Reference to a NodeJSAppAPIGateway controller service</li>
    <li><strong>Endpoint Pattern</strong> - URL pattern to handle (e.g., <code>/api/events</code>)</li>
</ul>

<h3>Optional Properties</h3>
<ul>
    <li><strong>Response Status Code</strong> - HTTP status code to return (default: 202 Accepted)</li>
    <li><strong>Response Body</strong> - Optional response body content</li>
</ul>

<h2>Endpoint Patterns</h2>
<p>Endpoint patterns support path parameters using colon notation:</p>

<table>
    <tr>
        <th>Pattern</th>
        <th>Matches</th>
        <th>Path Parameters</th>
    </tr>
    <tr>
        <td><code>/api/events</code></td>
        <td>Exact match only</td>
        <td>None</td>
    </tr>
    <tr>
        <td><code>/users/:userId</code></td>
        <td><code>/users/123</code></td>
        <td><code>userId=123</code></td>
    </tr>
    <tr>
        <td><code>/users/:userId/posts/:postId</code></td>
        <td><code>/users/123/posts/456</code></td>
        <td><code>userId=123, postId=456</code></td>
    </tr>
</table>

<h2>FlowFile Attributes</h2>
<p>Each FlowFile created from a request includes these attributes:</p>

<table>
    <tr>
        <th>Attribute</th>
        <th>Example</th>
        <th>Description</th>
    </tr>
    <tr>
        <td><code>http.method</code></td>
        <td>POST</td>
        <td>HTTP method</td>
    </tr>
    <tr>
        <td><code>http.path</code></td>
        <td>/api/events</td>
        <td>Request path</td>
    </tr>
    <tr>
        <td><code>http.query.*</code></td>
        <td>http.query.id=123</td>
        <td>Query parameters</td>
    </tr>
    <tr>
        <td><code>http.path.*</code></td>
        <td>http.path.userId=456</td>
        <td>Path parameters from URL pattern</td>
    </tr>
    <tr>
        <td><code>http.header.*</code></td>
        <td>http.header.content-type</td>
        <td>HTTP headers (lowercase)</td>
    </tr>
    <tr>
        <td><code>http.client.address</code></td>
        <td>127.0.0.1</td>
        <td>Client IP address</td>
    </tr>
    <tr>
        <td><code>http.timestamp</code></td>
        <td>2024-01-15T10:30:45Z</td>
        <td>Request timestamp (ISO-8601)</td>
    </tr>
</table>

<p>The FlowFile content contains the request body (if any).</p>

<h2>Example Usage</h2>

<h3>Node.js Application</h3>
<pre>
const GATEWAY_URL = process.env.NIFI_GATEWAY_URL || 'http://localhost:5050';

async function sendEvent(eventData) {
  const response = await fetch(`${GATEWAY_URL}/api/events`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(eventData)
  });

  if (response.status === 202) {
    console.log('Event accepted by NiFi');
  } else if (response.status === 503) {
    console.warn('NiFi queue full, retry later');
  }
}

// Send an event
sendEvent({
  eventType: 'DEFECT_DETECTED',
  severity: 'HIGH',
  productId: 'PROD-12345',
  timestamp: new Date().toISOString()
});
</pre>

<h3>NiFi Configuration</h3>
<ol>
    <li>Add and enable a <strong>NodeJSAppAPIGateway</strong> controller service (default port: 5050)</li>
    <li>Add a <strong>ReceiveFromNodeJSApp</strong> processor</li>
    <li>Set the <strong>Gateway Service</strong> property to reference the controller service</li>
    <li>Set the <strong>Endpoint Pattern</strong> to <code>/api/events</code></li>
    <li>Start the processor</li>
</ol>

<h2>Response Codes</h2>
<p>The gateway returns these HTTP status codes:</p>

<table>
    <tr>
        <th>Code</th>
        <th>Meaning</th>
        <th>Action</th>
    </tr>
    <tr>
        <td>202</td>
        <td>Accepted</td>
        <td>Request queued successfully</td>
    </tr>
    <tr>
        <td>400</td>
        <td>Bad Request</td>
        <td>Invalid request format</td>
    </tr>
    <tr>
        <td>404</td>
        <td>Not Found</td>
        <td>Endpoint not registered</td>
    </tr>
    <tr>
        <td>413</td>
        <td>Payload Too Large</td>
        <td>Request body exceeds limit</td>
    </tr>
    <tr>
        <td>503</td>
        <td>Service Unavailable</td>
        <td>Queue full, retry later</td>
    </tr>
</table>

<h2>Performance</h2>
<ul>
    <li><strong>Latency</strong>: Sub-millisecond (direct queue access)</li>
    <li><strong>Throughput</strong>: 10,000+ requests/second</li>
    <li><strong>Use Case</strong>: High-performance, production workloads</li>
</ul>

<h2>Monitoring</h2>
<p>
    Access real-time metrics at <code>http://localhost:5050/_metrics</code> to monitor request
    counts, success rates, average latency, and current queue size for each endpoint.
</p>

<h2>Troubleshooting</h2>

<h3>Endpoint Not Found (404)</h3>
<p>Verify that:</p>
<ul>
    <li>The processor is running (not stopped)</li>
    <li>The gateway controller service is enabled</li>
    <li>The endpoint pattern matches exactly</li>
</ul>

<h3>Queue Full (503) Responses</h3>
<p>
    Increase the queue size in the gateway controller service configuration, or add more concurrent
    tasks to the processor to process requests faster.
</p>

<h3>No Queue Found Error</h3>
<p>
    Check the logs. This error indicates the endpoint wasn't registered properly. Stop and restart
    the processor to re-register the endpoint.
</p>

<h2>See Also</h2>
<ul>
    <li><strong>NodeJSAppAPIGateway</strong> - Controller service that provides the HTTP gateway</li>
    <li><strong>ReceiveFromNodeJSApp (Python)</strong> - Python alternative with polling-based integration</li>
</ul>

</body>
</html>
